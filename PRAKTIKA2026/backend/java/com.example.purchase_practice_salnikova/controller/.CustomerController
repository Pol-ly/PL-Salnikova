package com.example.purchase_practice_salnikova.controller;

import com.example.purchase_practice_salnikova.dto.CustomerDTO;
import com.example.purchase_practice_salnikova.jooq.tables.Customer;
import com.example.purchase_practice_salnikova.jooq.tables.records.CustomerRecord;
import org.jooq.DSLContext;
import org.jooq.SortField;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/customers")
@CrossOrigin(origins = "*") // для работы с React фронтендом
public class CustomerController {

    @Autowired
    private DSLContext dsl;

    private final Customer C = Customer.CUSTOMER;

    // 1. ПОЛУЧЕНИЕ всех клиентов
    @GetMapping
    public List<Map<String, Object>> getAllCustomers() {
        return dsl.selectFrom(C)
                .orderBy(C.CUSTOMER_CODE.asc())
                .fetchMaps();
    }

    // 2. ПОЛУЧЕНИЕ клиента по коду
    @GetMapping("/{code}")
    public ResponseEntity<Map<String, Object>> getCustomerByCode(@PathVariable String code) {
        var record = dsl.selectFrom(C)
                .where(C.CUSTOMER_CODE.eq(code))
                .fetchOne();

        if (record == null) {
            return ResponseEntity.notFound().build();
        }

        return ResponseEntity.ok(record.intoMap());
    }

    // 3. ФИЛЬТРАЦИЯ и СОРТИРОВКА
    @GetMapping("/filter")
    public List<Map<String, Object>> getFilteredCustomers(
            @RequestParam(required = false) String name,
            @RequestParam(required = false) String inn,
            @RequestParam(defaultValue = "customer_code") String sortBy,
            @RequestParam(defaultValue = "asc") String order) {

        var query = dsl.selectFrom(C);

        // Фильтрация
        if (name != null && !name.isEmpty()) {
            query.where(C.CUSTOMER_NAME.likeIgnoreCase("%" + name + "%"));
        }
        if (inn != null && !inn.isEmpty()) {
            query.where(C.CUSTOMER_INN.eq(inn));
        }

        // Сортировка
        SortField<?> sortField;
        switch (sortBy.toLowerCase()) {
            case "customer_name":
                sortField = "asc".equalsIgnoreCase(order)
                        ? C.CUSTOMER_NAME.asc()
                        : C.CUSTOMER_NAME.desc();
                break;
            case "customer_inn":
                sortField = "asc".equalsIgnoreCase(order)
                        ? C.CUSTOMER_INN.asc()
                        : C.CUSTOMER_INN.desc();
                break;
            default:
                sortField = "asc".equalsIgnoreCase(order)
                        ? C.CUSTOMER_CODE.asc()
                        : C.CUSTOMER_CODE.desc();
        }

        return query.orderBy(sortField).fetchMaps();
    }

    // 4. СОЗДАНИЕ нового клиента
    @PostMapping
    public ResponseEntity<String> createCustomer(@RequestBody CustomerDTO customerDTO) {
        try {
            CustomerRecord record = dsl.newRecord(C);

            record.setCustomerCode(customerDTO.getCustomerCode());
            record.setCustomerName(customerDTO.getCustomerName());
            record.setCustomerInn(customerDTO.getCustomerInn());
            record.setCustomerKpp(customerDTO.getCustomerKpp());
            record.setCustomerLegalAddress(customerDTO.getCustomerLegalAddress());
            record.setCustomerPostalAddress(customerDTO.getCustomerPostalAddress());
            record.setCustomerEmail(customerDTO.getCustomerEmail());
            record.setCustomerCodeMain(customerDTO.getCustomerCodeMain());
            record.setIsOrganization(customerDTO.getIsOrganization() != null ? customerDTO.getIsOrganization() : false);
            record.setIsPerson(customerDTO.getIsPerson() != null ? customerDTO.getIsPerson() : false);

            record.store();

            return ResponseEntity.ok("Клиент создан успешно");
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Ошибка при создании клиента: " + e.getMessage());
        }
    }

    // 5. ОБНОВЛЕНИЕ клиента
    @PutMapping("/{code}")
    public ResponseEntity<String> updateCustomer(@PathVariable String code, @RequestBody CustomerDTO customerDTO) {
        int updated = dsl.update(C)
                .set(C.CUSTOMER_NAME, customerDTO.getCustomerName())
                .set(C.CUSTOMER_INN, customerDTO.getCustomerInn())
                .set(C.CUSTOMER_KPP, customerDTO.getCustomerKpp())
                .set(C.CUSTOMER_LEGAL_ADDRESS, customerDTO.getCustomerLegalAddress())
                .set(C.CUSTOMER_POSTAL_ADDRESS, customerDTO.getCustomerPostalAddress())
                .set(C.CUSTOMER_EMAIL, customerDTO.getCustomerEmail())
                .set(C.CUSTOMER_CODE_MAIN, customerDTO.getCustomerCodeMain())
                .set(C.IS_ORGANIZATION, customerDTO.getIsOrganization() != null ? customerDTO.getIsOrganization() : false)
                .set(C.IS_PERSON, customerDTO.getIsPerson() != null ? customerDTO.getIsPerson() : false)
                .where(C.CUSTOMER_CODE.eq(code))
                .execute();

        if (updated == 0) {
            return ResponseEntity.notFound().build();
        }

        return ResponseEntity.ok("Клиент обновлен успешно");
    }

    // 6. УДАЛЕНИЕ клиента
    @DeleteMapping("/{code}")
    public ResponseEntity<String> deleteCustomer(@PathVariable String code) {
        try {
            int deleted = dsl.deleteFrom(C)
                    .where(C.CUSTOMER_CODE.eq(code))
                    .execute();

            if (deleted == 0) {
                return ResponseEntity.notFound().build();
            }

            return ResponseEntity.ok("Клиент удален успешно");
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Ошибка при удалении: " + e.getMessage());
        }
    }
}
